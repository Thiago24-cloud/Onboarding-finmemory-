-- ============================================
-- TABELA PARA RASTREAR PROGRESSO DO ONBOARDING
-- ============================================

-- Criar tabela
CREATE TABLE IF NOT EXISTS onboarding_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Identificação do usuário (usamos email ou session_id)
    email TEXT,
    session_id TEXT,
    
    -- Progresso
    current_step INTEGER DEFAULT 1,
    completed BOOLEAN DEFAULT FALSE,
    
    -- Passos completados (array de números dos passos)
    steps_completed INTEGER[] DEFAULT ARRAY[]::INTEGER[],
    
    -- Tempo gasto (em segundos)
    time_spent INTEGER DEFAULT 0,
    
    -- Quando começou e terminou
    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE,
    
    -- Última atualização
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- Metadados
    device_type TEXT, -- 'mobile' ou 'desktop'
    browser TEXT,
    referrer TEXT,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Criar índices para performance
CREATE INDEX IF NOT EXISTS idx_onboarding_email ON onboarding_progress(email);
CREATE INDEX IF NOT EXISTS idx_onboarding_session ON onboarding_progress(session_id);
CREATE INDEX IF NOT EXISTS idx_onboarding_completed ON onboarding_progress(completed);
CREATE INDEX IF NOT EXISTS idx_onboarding_created_at ON onboarding_progress(created_at DESC);

-- Habilitar Row Level Security (RLS)
ALTER TABLE onboarding_progress ENABLE ROW LEVEL SECURITY;

-- Política: Permitir INSERT público (qualquer um pode registrar progresso)
CREATE POLICY "Permitir INSERT público"
ON onboarding_progress
FOR INSERT
TO public
WITH CHECK (true);

-- Política: Permitir UPDATE público (qualquer um pode atualizar seu progresso)
CREATE POLICY "Permitir UPDATE público"
ON onboarding_progress
FOR UPDATE
TO public
USING (true)
WITH CHECK (true);

-- Política: Permitir SELECT público (qualquer um pode ver dados)
-- NOTA: Em produção, você pode querer restringir isso
CREATE POLICY "Permitir SELECT público"
ON onboarding_progress
FOR SELECT
TO public
USING (true);

-- ============================================
-- COMENTÁRIOS
-- ============================================

COMMENT ON TABLE onboarding_progress IS 'Rastreia o progresso dos usuários no onboarding do FinMemory';
COMMENT ON COLUMN onboarding_progress.email IS 'Email do usuário (se fornecido)';
COMMENT ON COLUMN onboarding_progress.session_id IS 'ID único da sessão para usuários anônimos';
COMMENT ON COLUMN onboarding_progress.current_step IS 'Passo atual do onboarding (1-6)';
COMMENT ON COLUMN onboarding_progress.completed IS 'Se o usuário completou todo o onboarding';
COMMENT ON COLUMN onboarding_progress.steps_completed IS 'Array com números dos passos completados';
COMMENT ON COLUMN onboarding_progress.time_spent IS 'Tempo total gasto no onboarding (segundos)';

-- ============================================
-- QUERIES ÚTEIS PARA ANÁLISE
-- ============================================

-- Ver progresso geral
-- SELECT 
--     COUNT(*) as total_iniciados,
--     COUNT(*) FILTER (WHERE completed = true) as total_completados,
--     ROUND(100.0 * COUNT(*) FILTER (WHERE completed = true) / COUNT(*), 2) as taxa_conclusao
-- FROM onboarding_progress;

-- Ver em qual passo as pessoas desistem
-- SELECT 
--     current_step,
--     COUNT(*) as pessoas_neste_passo,
--     COUNT(*) FILTER (WHERE completed = false) as desistiram
-- FROM onboarding_progress
-- GROUP BY current_step
-- ORDER BY current_step;

-- Ver tempo médio para completar
-- SELECT 
--     AVG(time_spent) as tempo_medio_segundos,
--     AVG(time_spent) / 60 as tempo_medio_minutos
-- FROM onboarding_progress
-- WHERE completed = true;

-- Ver taxa de conclusão por dispositivo
-- SELECT 
--     device_type,
--     COUNT(*) as total,
--     COUNT(*) FILTER (WHERE completed = true) as completados,
--     ROUND(100.0 * COUNT(*) FILTER (WHERE completed = true) / COUNT(*), 2) as taxa_conclusao
-- FROM onboarding_progress
-- GROUP BY device_type;
